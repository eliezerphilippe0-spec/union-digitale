rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Transaction Security Rules
    match /transactions/{transactionId} {
      
      // Allow users to read their own transactions
      allow read: if request.auth != null 
                  && request.auth.uid == resource.data.userId;
      
      // Allow users to create transactions for themselves
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId
                    && request.resource.data.keys().hasAll([
                      'userId', 'type', 'amount', 'currency', 
                      'status', 'createdAt', 'updatedAt'
                    ])
                    && request.resource.data.status == 'pending'
                    && request.resource.data.amount > 0
                    && request.resource.data.amount <= 100000
                    && request.resource.data.currency == 'HTG';
      
      // Allow users to update only specific fields of their own transactions
      allow update: if request.auth != null 
                    && request.auth.uid == resource.data.userId
                    && request.resource.data.userId == resource.data.userId
                    && request.resource.data.type == resource.data.type
                    && request.resource.data.amount == resource.data.amount
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['status', 'updatedAt', 'metadata']);
      
      // Prevent deletion of transactions
      allow delete: if false;
    }
    
    // Admin access to all transactions (optional)
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null 
                         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
