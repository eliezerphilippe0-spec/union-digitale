rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }
    
    function isSeller() {
      // SECURITY: Use custom claims only to prevent privilege escalation
      return isAuthenticated() && (request.auth.token.role == 'seller' || request.auth.token.role == 'admin');
    }
    
    function isVerifiedSeller() {
      return isSeller() && request.auth.token.verified == true;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================================================
    // VENDOR COLLECTIONS
    // ========================================================================
    
    // Vendors - Public read, owner can update (limited fields)
    match /vendors/{vendorId} {
      allow read: if true; // Public vendor profiles
      
      allow create: if isAuthenticated() && 
                       request.auth.uid == vendorId &&
                       request.resource.data.userId == vendorId;
      
      allow update: if isOwner(vendorId) &&
                       // Cannot modify these fields (backend only)
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['verificationStatus', 'verificationLevel', 'commissionRate', 
                                 'totalSales', 'totalOrders', 'rating']);
      
      allow delete: if isAdmin();
    }
    
    // Wallets - Owner read only, backend writes
    match /wallets/{vendorId} {
      allow read: if isOwner(vendorId) || isAdmin();
      allow write: if false; // Only backend can write
    }
    
    // Wallet Transactions - Owner read only, backend writes
    match /wallet_transactions/{transactionId} {
      allow read: if isOwner(resource.data.vendorId) || isAdmin();
      allow write: if false; // Only backend can write
    }
    
    // Payouts - Owner can create and read, backend processes
    match /payouts/{payoutId} {
      allow create: if isAuthenticated() &&
                       request.resource.data.vendorId == request.auth.uid &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.amount > 0 &&
                       request.resource.data.amount >= 500 && // Minimum payout
                       request.resource.data.method in ['moncash', 'natcash', 'bank_transfer'];
      
      allow read: if isOwner(resource.data.vendorId) || isAdmin();
      
      // Can only cancel if pending
      allow update: if isOwner(resource.data.vendorId) &&
                       resource.data.status == 'pending' &&
                       request.resource.data.status == 'cancelled';
      
      allow delete: if false;
    }
    
    // Commission Rules - Read only for vendors, admin can write
    match /commission_rules/{ruleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Vendor Reviews - Users can create, vendor can respond
    match /vendor_reviews/{reviewId} {
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.rating >= 1 &&
                       request.resource.data.rating <= 5 &&
                       request.resource.data.comment.size() >= 10 &&
                       request.resource.data.comment.size() <= 1000;
      
      allow read: if true; // Public reviews
      
      // Vendor can add response
      allow update: if isOwner(resource.data.vendorId) &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['response', 'respondedAt']);
      
      allow delete: if isAdmin();
    }
    
    // Vendor Disputes - Users can create, admin manages
    match /vendor_disputes/{disputeId} {
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'open' &&
                       request.resource.data.description.size() >= 20;
      
      allow read: if isOwner(resource.data.userId) || 
                     isOwner(resource.data.vendorId) || 
                     isAdmin();
      
      allow update: if isAdmin(); // Only admin can update disputes
      
      allow delete: if isAdmin();
    }
    
    // Platform Revenue - Admin only
    match /platform_revenue/{revenueId} {
      allow read: if isAdmin();
      allow write: if false; // Only backend
    }
    
    // ========================================================================
    // EXISTING COLLECTIONS (from previous rules)
    // ========================================================================
    
    // Users
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isAdmin();
    }
    
    // Products
    match /products/{productId} {
      allow read: if true;
      allow create: if isSeller();
      allow update: if isAdmin() || (isSeller() && resource.data.vendorId == request.auth.uid);
      allow delete: if isAdmin() || (isSeller() && resource.data.vendorId == request.auth.uid);
    }
    
    // Digital Files - Protected: only buyers who purchased can access
    match /digital_files/{fileId} {
      allow read: if isAdmin() || 
                     (isAuthenticated() && 
                      exists(/databases/$(database)/documents/purchases/$(request.auth.uid + '_' + fileId)));
      allow write: if isAdmin() || 
                      (isSeller() && request.resource.data.vendorId == request.auth.uid);
    }
    
    // Purchases - Track who bought what (for digital file access)
    match /purchases/{purchaseId} {
      allow read: if isAuthenticated() && 
                     (purchaseId.matches(request.auth.uid + '_.*') || isAdmin());
      allow create: if false; // Backend only (after payment confirmation)
      allow update: if false;
      allow delete: if isAdmin();
    }
    
    // Orders (parent)
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
        resource.data.buyerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      ) || isAdmin();
      allow create, update, delete: if false; // server only
    }

    // Pickup hubs (pilot)
    match /pickup_hubs/{hubId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // Order Subs (per vendor)
    match /orderSubs/{subOrderId} {
      allow read: if isAuthenticated() && (
        resource.data.buyerId == request.auth.uid ||
        resource.data.vendorId == request.auth.uid
      ) || isAdmin();
      allow create, update, delete: if false; // server only
    }

    // Order Items (per suborder)
    match /orderItems/{itemId} {
      allow read: if isAuthenticated() && (
        resource.data.buyerId == request.auth.uid ||
        resource.data.vendorId == request.auth.uid
      ) || isAdmin();
      allow create, update, delete: if false; // server only
    }
    
    // Transactions
    match /transactions/{transactionId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      allow update: if false; // Immutable
      
      allow delete: if isAdmin();
    }
    
    // Messages (participants-only)
    function isParticipantMessage(data) {
      return isAuthenticated() && (
        (data.participants is list && data.participants.hasAny([request.auth.uid])) ||
        (data.buyerId == request.auth.uid) ||
        (data.sellerId == request.auth.uid)
      );
    }

    function messageOnlyAllowedFields() {
      return request.resource.data.keys().hasOnly([
        "threadId",
        "participants",
        "buyerId",
        "sellerId",
        "senderId",
        "text",
        "createdAt",
        "type",
        "attachments"
      ]);
    }

    function validMessageCreate() {
      return request.resource.data.senderId == request.auth.uid &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.text is string &&
        request.resource.data.text.size() <= 2000;
    }

    match /messages/{messageId} {
      allow read: if isParticipantMessage(resource.data) || isAdmin();
      allow create: if isAuthenticated() && messageOnlyAllowedFields() && isParticipantMessage(request.resource.data) && validMessageCreate();
      allow update: if false;
      allow delete: if (isParticipantMessage(resource.data) && resource.data.senderId == request.auth.uid) || isAdmin();
    }
    
    // System events (silent observability)
    match /system_events/{eventId} {
      allow create: if isAuthenticated() && (
        (
          request.resource.data.eventName == 'buyer_suborders_fallback_used' &&
          request.resource.data.buyerId == request.auth.uid &&
          request.resource.data.orderId is string &&
          request.resource.data.reason in ['query_error', 'index_missing'] &&
          request.resource.data.keys().hasOnly(['eventName', 'buyerId', 'orderId', 'reason', 'createdAt']) &&
          request.resource.data.createdAt is timestamp
        ) || (
          request.resource.data.eventName == 'firestore_index_missing' &&
          request.resource.data.reason == 'index_missing' &&
          request.resource.data.page is string &&
          request.resource.data.collection is string &&
          request.resource.data.keys().hasOnly(['eventName', 'page', 'collection', 'reason', 'createdAt']) &&
          request.resource.data.createdAt is timestamp
        )
      );
      allow read, update, delete: if false;
    }

    match /analytics_events/{eventId} {
      allow create: if isAuthenticated() &&
        request.resource.data.eventName == 'verified_seller_badge_impression' &&
        request.resource.data.storeId is string &&
        request.resource.data.location is string &&
        request.resource.data.createdAt is timestamp &&
        (
          request.resource.data.keys().hasOnly(['eventName', 'storeId', 'location', 'createdAt']) ||
          request.resource.data.keys().hasOnly(['eventName', 'storeId', 'location', 'productId', 'createdAt'])
        );
      allow read, update, delete: if false;
    }

    // Notifications
    match /notifications/{notificationId} {
      allow create: if isAuthenticated();
      allow read: if isOwner(resource.data.userId);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }
  }
}
