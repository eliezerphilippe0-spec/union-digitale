// Union Digitale Database Schema
// Using Prisma ORM with PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== USERS ==============

enum UserRole {
  BUYER
  SELLER
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  BANNED
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  phone         String?    @unique
  passwordHash  String
  firstName     String
  lastName      String
  avatar        String?
  role          UserRole   @default(BUYER)
  status        UserStatus @default(PENDING)
  emailVerified Boolean    @default(false)
  phoneVerified Boolean    @default(false)
  
  // Loyalty
  loyaltyPoints Int        @default(0)
  loyaltyTier   String     @default("bronze")

  // Cashback
  cashbackBalance  Float   @default(0)
  cashbackLifetime Float   @default(0)
  
  // Points Wallet
  pointsWallet PointsWallet?

  // Timestamps
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  store         Store?
  orders        Order[]
  reviews       Review[]
  addresses     Address[]
  favorites     Favorite[]
  cart          CartItem[]
  notifications Notification[]
  cashbackTransactions CashbackTransaction[]
  pointsLedger PointsLedger[]
  
  @@index([email])
  @@index([phone])
}

model Address {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  label       String   // "Maison", "Bureau", etc.
  fullName    String
  phone       String
  street      String
  city        String
  department  String   // Département d'Haïti
  country     String   @default("Haïti")
  postalCode  String?
  instructions String?
  isDefault   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  orders      Order[]
  
  @@index([userId])
}

// ============== STORES ==============

enum StoreStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
}

model Store {
  id              String      @id @default(uuid())
  userId          String      @unique
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String
  slug            String      @unique
  description     String?
  logo            String?
  banner          String?
  status          StoreStatus @default(PENDING)
  
  // Contact
  email           String?
  phone           String?
  whatsapp        String?
  
  // Location
  address         String?
  city            String?
  department      String?
  
  // Business Info
  businessType    String?     // "individual", "company"
  taxId           String?     // NIF
  
  // Stats
  rating          Float       @default(0)
  reviewCount     Int         @default(0)
  totalSales      Int         @default(0)
  
  // Seller Credit
  creditLimit     Float       @default(0)
  creditUsed      Float       @default(0)
  creditScore     Int         @default(0)
  
  // Commission
  commissionRate  Float       @default(0.10) // 10% default
  
  // Verification
  isVerified      Boolean     @default(false)
  verifiedAt      DateTime?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  products        Product[]
  orders          Order[]
  payouts         Payout[]
  
  @@index([slug])
  @@index([status])
}

// ============== PRODUCTS ==============

enum ProductStatus {
  DRAFT
  PENDING
  ACTIVE
  REJECTED
  OUT_OF_STOCK
  ARCHIVED
}

model Category {
  id          String     @id @default(uuid())
  name        String
  slug        String     @unique
  description String?
  icon        String?
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  products    Product[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@index([slug])
  @@index([parentId])
}

model Product {
  id              String        @id @default(uuid())
  storeId         String
  store           Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category      @relation(fields: [categoryId], references: [id])
  
  title           String
  slug            String        @unique
  description     String
  shortDescription String?
  
  // Pricing
  price           Float
  comparePrice    Float?        // Prix barré
  costPrice       Float?        // Prix d'achat (pour analytics)
  currency        String        @default("HTG")
  
  // Inventory
  sku             String?
  barcode         String?
  stock           Int           @default(0)
  lowStockThreshold Int         @default(5)
  trackInventory  Boolean       @default(true)
  
  // Media
  images          String[]      // Array of image URLs
  
  // Attributes
  brand           String?
  weight          Float?
  dimensions      Json?         // {length, width, height}
  attributes      Json?         // Custom attributes
  
  // Status
  status          ProductStatus @default(DRAFT)
  isFeatured      Boolean       @default(false)
  
  // Stats
  viewCount       Int           @default(0)
  salesCount      Int           @default(0)
  rating          Float         @default(0)
  reviewCount     Int           @default(0)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  reviews         Review[]
  orderItems      OrderItem[]
  cartItems       CartItem[]
  favorites       Favorite[]
  
  @@index([storeId])
  @@index([categoryId])
  @@index([slug])
  @@index([status])
}

// ============== ORDERS ==============

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH_ON_DELIVERY
  MONCASH
  NATCASH
  CARD
  BANK_TRANSFER
}

model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  storeId         String
  store           Store         @relation(fields: [storeId], references: [id])
  addressId       String
  address         Address       @relation(fields: [addressId], references: [id])
  
  // Status
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   PaymentMethod
  
  // Amounts
  subtotal        Float
  shippingCost    Float         @default(0)
  tax             Float         @default(0)
  discount        Float         @default(0)
  total           Float
  
  // Payment Info
  paymentId       String?       // External payment ID
  paidAt          DateTime?

  // Commission
  commissionRate   Float        @default(0.10)
  commissionAmount Float        @default(0)
  sellerNetAmount  Float        @default(0)
  
  // Shipping
  shippingMethod  String?
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  // Notes
  customerNote    String?
  sellerNote      String?
  
  // Loyalty
  pointsEarned    Int           @default(0)
  pointsUsed      Int           @default(0)

  // Points (frozen at initialize)
  pointsApplied              Int  @default(0)
  pointsDiscountHtg          Int  @default(0)
  pointsValueHtgAtRedemption Int  @default(10)
  pointsMaxPercent           Int  @default(20)
  pointsEligibleSubtotalHtg  Int  @default(0)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  items           OrderItem[]
  
  @@index([userId])
  @@index([storeId])
  @@index([orderNumber])
  @@index([status])
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  title       String   // Snapshot du titre
  price       Float    // Snapshot du prix
  quantity    Int
  total       Float
  
  @@index([orderId])
  @@index([productId])
}

// ============== CART ==============

model CartItem {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  quantity    Int      @default(1)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, productId])
  @@index([userId])
}

// ============== REVIEWS ==============

model Review {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  rating      Int      // 1-5
  title       String?
  comment     String?
  images      String[]
  
  isVerified  Boolean  @default(false) // Achat vérifié
  isApproved  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, productId])
  @@index([productId])
}

// ============== FAVORITES ==============

model Favorite {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([userId, productId])
  @@index([userId])
}

// ============== PAYOUTS ==============

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Payout {
  id          String       @id @default(uuid())
  storeId     String
  store       Store        @relation(fields: [storeId], references: [id])
  
  amount      Float
  fee         Float        @default(0)
  netAmount   Float
  currency    String       @default("HTG")
  
  method      String       // "moncash", "bank_transfer"
  accountInfo Json         // Détails du compte
  
  status      PayoutStatus @default(PENDING)
  processedAt DateTime?
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([storeId])
  @@index([status])
}

// ============== NOTIFICATIONS ==============

model Notification {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String   // "order", "promotion", "system"
  title       String
  message     String
  data        Json?
  
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
}

// ============== CASHBACK ==============

enum CashbackStatus {
  AVAILABLE
  REDEEMED
  EXPIRED
}

model CashbackTransaction {
  id        String         @id @default(uuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId   String?
  amount    Float
  status    CashbackStatus @default(AVAILABLE)
  createdAt DateTime       @default(now())
  expiresAt DateTime

  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@index([expiresAt])
}

// ============== POINTS ==============

enum PointsTxType {
  EARN
  REDEEM
  ADJUST
  REFUND
  EXPIRE
}

enum PointsTxStatus {
  PENDING
  COMMITTED
  CANCELED
  EXPIRED
}

model PointsWallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance   Int      @default(0)
  version   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ledger    PointsLedger[]
}

model PointsLedger {
  id             String        @id @default(cuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  walletId       String
  wallet         PointsWallet  @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type           PointsTxType
  status         PointsTxStatus @default(PENDING)
  points         Int
  amountHtg      Int?
  orderId        String?
  paymentId      String?
  reason         String?
  meta           Json?
  idempotencyKey String?       @unique
  expiresAt      DateTime?
  createdAt      DateTime      @default(now())
  committedAt    DateTime?

  @@index([userId])
  @@index([orderId])
  @@index([status])
}
